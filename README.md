# Embeded_System_Software
┌─────────────────────────────────────────────────────────────────────────────┐
│                        KV Index (RESERVED0 영역)                             │
│                     시작: 0x00300000, 크기: ~23MB                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Index 0     Index 1     Index 2           ...         Index 5,992,438     │
│  ┌───────┐   ┌───────┐   ┌───────┐                     ┌───────┐           │
│  │ key   │   │ key   │   │ key   │         ...         │ key   │           │
│  │(4byte)│   │(4byte)│   │(4byte)│                     │(4byte)│           │
│  └───────┘   └───────┘   └───────┘                     └───────┘           │
│                                                                             │
│   EMPTY = 0xFFFFFFFF (빈 슬롯)                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           Double Hashing 동작                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Key = 12345                                                               │
│                                                                             │
│   ① Primary Hash (MurmurHash3 finalizer)                                   │
│      h1(12345) = 2,847,291                                                  │
│                                                                             │
│   ② Secondary Hash (Step 계산, 항상 홀수)                                    │
│      h2(12345) = 1,573,847                                                  │
│                                                                             │
│   ③ Probing Sequence:                                                      │
│      시도 0: (2,847,291 + 0 × 1,573,847) % 5,992,439 = 2,847,291           │
│      시도 1: (2,847,291 + 1 × 1,573,847) % 5,992,439 = 4,421,138           │
│      시도 2: (2,847,291 + 2 × 1,573,847) % 5,992,439 =   1,002,546         │
│      ...                                                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              INSERT 예시                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   PUT(key=100, value=...)                                                   │
│                                                                             │
│        h1(100)=idx        h2(100)=step                                      │
│            │                   │                                            │
│            ▼                   ▼                                            │
│   ┌────┬────┬────┬────┬────┬────┬────┬────┐                                │
│   │FULL│FULL│ ✓  │    │    │    │    │    │  ← 충돌 시 step만큼 이동       │
│   └────┴────┴────┴────┴────┴────┴────┴────┘                                │
│      ↑         ↑                                                            │
│    충돌!    빈 슬롯 발견 → key 저장                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


전체 아키텍처

┌─────────────────────────────────────────────────────────────────────────────┐
│                              FIND 예시                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   GET(key=100)                                                              │
│                                                                             │
│   동일한 probing sequence로 탐색:                                            │
│   - key 일치 → index 반환 (LBA = index로 변환)                              │
│   - EMPTY 발견 → 키 없음 (ENOSUCHKEY)                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            Host (Application)                                │
│                                                                             │
│                    PUT(key, value)     GET(key) → value                     │
└─────────────────────────────────────────┬───────────────────────────────────┘
                                          │ NVMe Command
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              KV-SSD Controller                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    KV Index (Hash Table)                            │   │
│  │                      - Key → Index 매핑                              │   │
│  │                      - Index = LBA로 사용                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         FTL (Flash Translation Layer)               │   │
│  │                      - LBA → PBA (Physical Block Address)           │   │
│  │                      - Page Mapping 방식                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
└────────────────────────────────────┼────────────────────────────────────────┘
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            NAND Flash Memory                                 │
│                                                                             │
│    ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐                      │
│    │ Channel │  │ Channel │  │ Channel │  │ Channel │                      │
│    │    0    │  │    1    │  │    2    │  │    3    │                      │
│    └─────────┘  └─────────┘  └─────────┘  └─────────┘                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         PUT(key=100, value="Hello")                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 1: Key를 Hash Table에 Insert                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   kv_index_insert(key=100)                                                  │
│                                                                             │
│   ① h1(100) = 3,847,291  (Primary Hash)                                    │
│   ② h2(100) = 1,234,567  (Step)                                            │
│   ③ 빈 슬롯 찾기 → Index = 3,847,291 반환                                   │
│                                                                             │
│   Hash Table:                                                               │
│   ┌────────┬────────┬────────┬────────┬────────┐                           │
│   │  ...   │  ...   │ key=100│  ...   │  ...   │                           │
│   └────────┴────────┴────────┴────────┴────────┘                           │
│                         ↑                                                   │
│                   Index 3,847,291                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 2: Index를 LBA로 변환                                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   startLba = index × NVME_BLOCKS_PER_SLICE                                  │
│            = 3,847,291 × 8                                                  │
│            = 30,778,328                                                     │
│                                                                             │
│   // NSID 오프셋 적용 (멀티 네임스페이스 지원)                                 │
│   actualLba = startLba + (storageCapacity / channels) × (nsid - 1)         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 3: FTL을 통해 Value를 Flash에 기록                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   handle_nvme_io_write(startLba, nlb=8)                                    │
│                                                                             │
│   ① ReqTransNvmeToSlice() - LBA를 Slice 단위로 변환                         │
│   ② LSA → VSA 변환 (Address Translation)                                   │
│   ③ Page Mapping으로 물리 위치 결정                                          │
│   ④ NAND Flash에 Value 기록                                                │
│                                                                             │
│   LBA 30,778,328  →  FTL  →  PBA (Channel, Way, Block, Page)               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              GET(key=100)                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 1: Key로 Hash Table 검색                                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   kv_index_find(key=100)                                                    │
│                                                                             │
│   ① h1(100) = 3,847,291  (동일한 Hash 함수 사용)                            │
│   ② h2(100) = 1,234,567  (동일한 Step 함수 사용)                            │
│   ③ Probing하며 key 탐색                                                   │
│                                                                             │
│   결과: Index = 3,847,291 반환 (키 발견)                                    │
│         또는 -1 반환 (ENOSUCHKEY)                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 2: Index를 LBA로 변환 (PUT과 동일한 계산)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   startLba = index × NVME_BLOCKS_PER_SLICE                                  │
│            = 3,847,291 × 8                                                  │
│            = 30,778,328                                                     │
│                                                                             │
│   // NSID 오프셋 적용 (PUT과 동일하게!)                                      │
│   actualLba = startLba + (storageCapacity / channels) × (nsid - 1)         │
│                                                                             │
│   ⚠️ 중요: PUT과 GET에서 동일한 LBA 계산 필수!                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 3: FTL을 통해 Flash에서 Value 읽기                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ReqTransNvmeToSliceKvGet(actualLba)                                      │
│                                                                             │
│   ① LBA → LSA 변환 (tempLsa = startLba / NVME_BLOCKS_PER_SLICE)           │
│   ② LSA → VSA 변환 (logicalSliceMapPtr->logicalSlice[lsa].virtualSliceAddr)│
│   ③ VSA → PBA 변환 (virtualSliceMapPtr->virtualSlice[vsa])                │
│   ④ NAND Flash에서 Value 읽기                                              │
│                                                                             │
│   PBA (Channel, Way, Block, Page)  →  Read  →  Value="Hello"               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                    동일 Key에 대한 Update (Overwrite)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   PUT(key=100, value="Hello")   ← 최초 저장                                 │
│   PUT(key=100, value="World")   ← 업데이트                                  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                      Hash Table                                     │  │
│   │                                                                     │  │
│   │   kv_index_insert(100) 호출 시:                                     │  │
│   │   - 이미 key=100 존재 → 동일한 Index 반환 (새 슬롯 할당 안 함)       │  │
│   │   - Index = 3,847,291 (변경 없음)                                   │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                     │                                       │
│                                     ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                           FTL                                       │  │
│   │                                                                     │  │
│   │   동일한 LBA에 새 Value 기록:                                        │  │
│   │   - Page Mapping FTL이 새 물리 페이지에 기록 (Out-of-place Update)  │  │
│   │   - 이전 페이지는 Invalid 처리                                       │  │
│   │   - Garbage Collection이 나중에 회수                                 │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                     │                                       │
│                                     ▼                                       │
│   결과: GET(key=100) → "World" (항상 최신 Value 반환)                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
